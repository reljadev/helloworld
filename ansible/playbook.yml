- name: Setup container environment
  hosts: helloworld
  become: true
  vars_files:
    - letsencrypt.yml
  vars:
    # Docker configuration
    docker_edition: 'docker-ce=5:28.4.0-1~ubuntu.22.04~jammy'
    docker_packages:
      - "docker-ce=5:28.4.0-1~ubuntu.22.04~jammy"
      - "docker-ce-cli=5:28.4.0-1~ubuntu.22.04~jammy"
      - "containerd.io=1.7.27-1"
      - "docker-buildx-plugin=0.27.0-1~ubuntu.22.04~jammy"

    docker_users:
      - azureadmin # TODO: should be the same user as in tf

    # Let's Encrypt configuration
    debug: false
    acme_dir: https://acme-v02.api.letsencrypt.org/directory
    cert_directory_user: root
    cert_directory_group: root

  # roles:
  #   - geerlingguy.docker

  tasks: # TODO: Should this be in a separate play?
    - name: Transfer project files
      ansible.builtin.copy:
        src: ../src/
        dest: /home/azureadmin/helloworld/
        owner: azureadmin
        group: azureadmin
        mode: '0755'

    - name: Include letsencrypt tasks for each certificate
      ansible.builtin.include_tasks: letsencrypt_tasks.yml
      loop: "{{ le_certificates }}"
